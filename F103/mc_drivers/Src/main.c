/**
 ******************************************************************************
 * @file           : main.c
 * @author         : Auto-generated by STM32CubeIDE
 * @brief          : Main program body
 ******************************************************************************
 * @attention
 *
 * Copyright (c) 2024 STMicroelectronics.
 * All rights reserved.
 *
 * This software is licensed under terms that can be found in the LICENSE file
 * in the root directory of this software component.
 * If no LICENSE file comes with this software, it is provided AS-IS.
 *
 ******************************************************************************
 */

/*
 *  ATTENTION: The rotary encoder worked fine with 1uF capacitor on pins CLK and DT
 */


#include "main.h"

// ####################################################################################

/* PRIVATE GLOBAL VARIABLES */
static uint8_t debug_buffer[1024];  // buffer to send data
static uint8_t counter;

// ####################################################################################

/* PRIVATE FUNCTIONS PROTOTYPES */
static void debug_send_msg(uint8_t *msg, uint8_t size);

static void button0_short_callback();           // callback when short pressed Button0
static void button0_long_callback();            // callback when long pressed Button0
static void button0_long_release_callback();    // callback when released after long press

static void button1_short_callback();           // callback when short pressed Button1
static void button1_long_callback();            // callback when long pressed Button1
static void button1_long_release_callback();    // callback when released after long press

static void encoder_clkwise_callback();
static void encoder_counter_clkwise_callback();
static void encoder_sw_callback();
static void encoder_config();
// ####################################################################################

int main(void)
{
    // Config System Clock to 64 MHz
    Sys_Clock_Init();

    // Config Timers
    Timer_Init();

    // Config Leds
    Leds_Config();

    // Config Encoder
    encoder_config();

    // Config BUTTONS
    Button_config(BUTTON0, BUTTON0_PORT, BUTTON0_PIN, BUTTON_ACTIVE_LOW, 20, 1000,      \
            button0_short_callback, button0_long_callback, button0_long_release_callback);

    Button_config(BUTTON1, BUTTON1_PORT, BUTTON1_PIN, BUTTON_ACTIVE_LOW, 20, 1000,      \
            button1_short_callback, button1_long_callback, button1_long_release_callback);

    // Config Buzzer
    Buzzer_Config(BUZZER_PORT, BUZZER_PIN);


    // Config Main Uart
    Uart_config(UART_MAIN, 115200, UART_NO_REMAP);

    // Config Debug Uart
    Uart_config(UART_DEBUG, 115200, UART_NO_REMAP);


    //Delay_ms(100);

    sprintf((char *)debug_buffer, "System init complete\r\n");
    debug_send_msg(debug_buffer, strlen((char *)debug_buffer));

    while(1)
    {
        uint8_t debug_read_val = 0;


        Timer_SM();
        if(Uart_Read_from_buffer(UART_DEBUG, &debug_read_val) == UART_OK)
        {
            Uart_Transmit(UART_DEBUG, &debug_read_val, 1); // echo
        }

    }// end while (1)

}// end main

/* PRIVATE FUNCTIONS */

static void button0_short_callback()
{
    Leds_Red_Led_Toggle();
}
static void button0_long_callback()
{
    static uint8_t blinking_flag = 0;
    if(blinking_flag)
    {
        Timer_Stop(TIMER_GREEN_LED);
        Leds_Green_Led_OFF();
        blinking_flag = 0;
    }
    else
    {
        Timer_Set(TIMER_GREEN_LED, TIME_500MS, Leds_Green_Led_Toggle, TIMER_MODE_ALWAYS);
        blinking_flag = 1;
    }
}
static void button0_long_release_callback()
{

}

static void button1_short_callback()
{
    Buzzer_short_beep(4);
}
static void button1_long_callback()
{
    Buzzer_long_beep(4);
}
static void button1_long_release_callback()
{

}



static void encoder_clkwise_callback()
{
    counter++;
    sprintf((char *)debug_buffer, "CLOCKWISE: %d\r\n", counter);
    Uart_Transmit(UART_DEBUG, debug_buffer, strlen((char *)debug_buffer));
}

static void encoder_counter_clkwise_callback()
{
    counter--;
    sprintf((char *)debug_buffer, "COUNTERCLOCKWISE %d\r\n", counter);
    debug_send_msg(debug_buffer, strlen((char *)debug_buffer));

}


static void encoder_sw_callback()
{
    sprintf((char *)debug_buffer, "Selected!\r\n");
    debug_send_msg(debug_buffer, strlen((char *)debug_buffer));
}


static void encoder_config()
{
    Encoder_Config_callbacks(encoder_clkwise_callback, encoder_counter_clkwise_callback, encoder_sw_callback);

    Encoder_Config_clk(ENCODER_CLK_PORT, ENCODER_CLK_PIN);
    Encoder_Config_dt(ENCODER_DT_PORT, ENCODER_DT_PIN);
    Encoder_Config_sw(ENCODER_SW_PORT, ENCODER_SW_PIN);

    Encoder_Init();
}











static void debug_send_msg(uint8_t *msg, uint8_t size)
#ifdef DEBUG_ENABLE
{
    Uart_Transmit(UART_DEBUG, msg, size);
}
#else
{
    // do nothing
}
#endif

// ####################################################################################

